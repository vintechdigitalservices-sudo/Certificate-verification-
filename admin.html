<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Panel - WeCare</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin:0; padding:0; font-family: 'Inter', sans-serif; }
  body { background:#e6f5ea; color:#333; padding:20px; }
  header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
  h1 { color:#28a745; margin:0; font-size:1.4rem; }
  .actions { display:flex; gap:8px; align-items:center; }

  .btn { padding:8px 12px; border-radius:6px; border:2px solid #001f54; background:#28a745; color:#fff; cursor:pointer; }
  .btn.ghost { background:transparent; color:#fff; border-color:#fff; }
  .btn.warn { background:#ffc107; border:none; color:#111; }
  .btn.danger { background:#dc3545; border:none; color:#fff; }

  form {
    background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,0.08); margin-bottom:22px;
  }
  form .row { display:flex; gap:12px; margin-bottom:10px; }
  form .col { flex:1; }
  label { display:block; margin-bottom:6px; font-size:13px; color:#333; }
  input[type="text"], input[type="file"], select, input[type="search"] {
    width:100%; padding:10px 12px; border-radius:6px; border:1px solid #ccc; font-size:14px;
  }
  .small { width:160px; }
  .progress { height:8px; background:#f1f5f9; border-radius:6px; overflow:hidden; margin-top:8px; }
  .progress > i { display:block; height:100%; width:0%; background:#28a745; transition:width .2s ease; }

  table { width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 6px 24px rgba(0,0,0,0.08); }
  th, td { padding:12px 10px; text-align:left; border-bottom:1px solid #eee; vertical-align:middle; }
  th { background:#28a745; color:#fff; font-weight:600; }
  tr:hover { background:#fafafa; }
  td img.passport { width:90px; height:110px; object-fit:cover; border-radius:6px; border:2px solid #ccc; display:block; }
  td .no-photo { width:90px; height:110px; border-radius:6px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; color:#999; font-size:12px; border:2px dashed #e2e8f0; }

  .meta { font-size:13px; color:#666; }
  .status-Verified { color:green; font-weight:600; }
  .status-NotVerified { color:#d9534f; font-weight:600; }

  .top-controls { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
  input[type="search"] { padding:8px 12px; border-radius:6px; border:1px solid #ccc; }

  footer { margin-top:18px; font-size:12px; color:#555; text-align:center; }
  @media (max-width:900px){
    form .row { flex-direction:column; }
    .small { width:100%; }
    th,td { font-size:13px; padding:8px; }
    td img.passport { width:70px; height:85px; }
    .no-photo { width:70px; height:85px; }
  }
</style>
</head>
<body>

<header>
  <h1>Admin Panel — WeCare</h1>
  <div class="actions">
    <input type="search" id="searchInput" placeholder="Search by name or cert ID" />
    <button class="btn" id="logoutBtn">Logout</button>
  </div>
</header>

<form id="studentForm">
  <h2 style="margin-bottom:10px;color:#28a745;">Add / Edit Student</h2>

  <div class="row">
    <div class="col">
      <label for="firstName">First Name *</label>
      <input id="firstName" type="text" placeholder="First name" required>
    </div>
    <div class="col">
      <label for="lastName">Last Name *</label>
      <input id="lastName" type="text" placeholder="Last name" required>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label for="otherName">Other Name</label>
      <input id="otherName" type="text" placeholder="Other name (optional)">
    </div>
    <div class="col">
      <label for="course">Course *</label>
      <input id="course" type="text" placeholder="Course (e.g., Basic Nursing)" required>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label for="field">Field / Department</label>
      <input id="field" type="text" placeholder="Field or department (optional)">
    </div>
    <div class="col small">
      <label for="certId">Certificate ID *</label>
      <input id="certId" type="text" placeholder="Unique certificate code" required>
    </div>
  </div>

  <div class="row">
    <div class="col small">
      <label for="status">Status *</label>
      <select id="status" required>
        <option value="Verified">Verified</option>
        <option value="Not Verified">Not Verified</option>
      </select>
    </div>

    <div class="col">
      <label for="imageFile">Student Image (optional) — passport-style preview</label>
      <input id="imageFile" type="file" accept="image/*">
      <div class="progress" id="uploadProgress" style="display:none"><i></i></div>
      <div id="imagePreview" style="margin-top:8px;"></div>
    </div>
  </div>

  <div style="display:flex; gap:8px; align-items:center; margin-top:12px;">
    <button class="btn" type="submit" id="submitBtn">Submit</button>
    <button type="button" id="resetBtn" style="background:#fff;border:2px solid #001f54;color:#001f54;padding:8px 12px;border-radius:6px;cursor:pointer;">Reset</button>
    <div style="margin-left:auto" class="meta">Tip: Certificate ID is used as document ID</div>
  </div>
</form>

<h2 style="margin-bottom:10px;color:#28a745;">All Students</h2>

<table id="studentsTable" aria-live="polite">
  <thead>
    <tr>
      <th style="width:110px">Photo</th>
      <th>Name</th>
      <th>Course / Field</th>
      <th>Certificate ID</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<footer>&copy; 2025 WeCare Nursing Services — Admin Panel</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDocs, collection, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBIM_jh15J2riP1XXtxP4hCmlbx1BqK5-8",
  authDomain: "wecare--verification.firebaseapp.com",
  projectId: "wecare--verification",
  storageBucket: "wecare--verification.appspot.com",
  messagingSenderId: "198997154830",
  appId: "1:198997154830:web:a732dc7abc306ed1a5f05f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const studentForm = document.getElementById('studentForm');
const firstNameEl = document.getElementById('firstName');
const lastNameEl = document.getElementById('lastName');
const otherNameEl = document.getElementById('otherName');
const courseEl = document.getElementById('course');
const fieldEl = document.getElementById('field');
const certIdEl = document.getElementById('certId');
const statusEl = document.getElementById('status');
const imageFileEl = document.getElementById('imageFile');
const uploadProgressEl = document.getElementById('uploadProgress');
const uploadProgressBar = uploadProgressEl.querySelector('i');
const imagePreview = document.getElementById('imagePreview');
const studentsTableBody = document.querySelector('#studentsTable tbody');
const searchInput = document.getElementById('searchInput');
const logoutBtn = document.getElementById('logoutBtn');
const resetBtn = document.getElementById('resetBtn');

let editingCertId = null;
let currentImageFile = null;

onAuthStateChanged(auth, (user) => {
  if (!user) window.location.href = "admin-login.html";
});

logoutBtn.addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = "admin-login.html";
});

imageFileEl.addEventListener('change', () => {
  const f = imageFileEl.files[0];
  currentImageFile = f || null;
  imagePreview.innerHTML = '';
  if (!f) return;
  const img = document.createElement('img');
  img.className = 'passport';
  img.src = URL.createObjectURL(f);
  imagePreview.appendChild(img);
});

async function uploadImageAndGetURL(certId) {
  if (!currentImageFile) return null;
  const filename = `${certId}_${Date.now()}_${currentImageFile.name.replace(/\s+/g,'_')}`;
  const sRef = storageRef(storage, `students/${certId}/${filename}`);
  const uploadTask = uploadBytesResumable(sRef, currentImageFile);
  uploadProgressEl.style.display = 'block';
  uploadProgressBar.style.width = '0%';
  return new Promise((resolve, reject) => {
    uploadTask.on('state_changed',
      (snapshot) => {
        const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
        uploadProgressBar.style.width = progress + '%';
      },
      (error) => { console.error('Upload failed', error); uploadProgressEl.style.display='none'; reject(error); },
      async () => { uploadProgressEl.style.display='none'; const downloadURL = await getDownloadURL(uploadTask.snapshot.ref); resolve(downloadURL); }
    );
  });
}

async function loadStudents(filterText = '') {
  studentsTableBody.innerHTML = '';
  const qSnapshot = await getDocs(collection(db, "Students"));
  const rows = [];
  qSnapshot.forEach(docSnap => {
    const s = docSnap.data();
    const searchable = `${s.firstName} ${s.lastName} ${s.otherName || ''} ${s.certId}`.toLowerCase();
    if (!filterText || searchable.includes(filterText.toLowerCase())) rows.push(s);
  });
  rows.sort((a,b) => (a.certId || '').toString().localeCompare((b.certId || '').toString()));
  for (const s of rows) {
    const tr = document.createElement('tr');
    const imgHtml = s.imageURL ? `<img class="passport" src="${s.imageURL}" alt="photo">` : `<div class="no-photo">No photo</div>`;
    const statusClass = (s.status || 'Not Verified').replace(/\s/g,'');
    tr.innerHTML = `
      <td style="width:110px">${imgHtml}</td>
      <td>
        <div style="font-weight:600">${escapeHtml(s.firstName)} ${escapeHtml(s.lastName)}</div>
        <div class="meta">${escapeHtml(s.otherName || '')}</div>
      </td>
      <td>
        <div style="font-weight:600">${escapeHtml(s.course || '-')}</div>
        <div class="meta">${escapeHtml(s.field || '-')}</div>
      </td>
      <td>${escapeHtml(s.certId)}</td>
      <td class="status-${escapeHtml(statusClass)}">${escapeHtml(s.status)}</td>
      <td>
        <button class="btn warn" onclick="editStudent('${escapeJs(s.certId)}')">Edit</button>
        <button class="btn danger" onclick="deleteStudent('${escapeJs(s.certId)}')">Delete</button>
      </td>`;
    studentsTableBody.appendChild(tr);
  }
  if (rows.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="6" style="text-align:center;padding:18px;color:#666">No students found.</td>`;
    studentsTableBody.appendChild(tr);
  }
}

studentForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const firstName = firstNameEl.value.trim();
  const lastName = lastNameEl.value.trim();
  const otherName = otherNameEl.value.trim();
  const course = courseEl.value.trim();
  const field = fieldEl.value.trim();
  const certId = certIdEl.value.trim();
  const status = statusEl.value;
  if (!firstName || !lastName || !certId || !course) { alert('Please fill in required fields.'); return; }

  try {
    let imageURL = null;
    if (currentImageFile) imageURL = await uploadImageAndGetURL(certId);
    else if (editingCertId) {
      const docSnap = await getDoc(doc(db, "Students", certId));
      if (docSnap.exists()) imageURL = docSnap.data().imageURL || '';
    }

    await setDoc(doc(db, "Students", certId), { firstName, lastName, otherName, course, field, certId, status, imageURL: imageURL || '' });
    alert('Student saved successfully.');
    studentForm.reset(); currentImageFile = null; imagePreview.innerHTML = ''; uploadProgressEl.style.display='none'; uploadProgressBar.style.width='0%';
    certIdEl.disabled = false; editingCertId = null;
    loadStudents(searchInput.value.trim());
  } catch(err) { console.error(err); alert('Error saving student.'); }
});

window.editStudent = async function(certId) {
  const docSnap = await getDoc(doc(db, "Students", certId));
  if (!docSnap.exists()) { alert('Record not found.'); return; }
  const s = docSnap.data();
  firstNameEl.value = s.firstName || '';
  lastNameEl.value = s.lastName || '';
  otherNameEl.value = s.otherName || '';
  courseEl.value = s.course || '';
  fieldEl.value = s.field || '';
  certIdEl.value = s.certId || '';
  certIdEl.disabled = true;
  statusEl.value = s.status || 'Not Verified';
  editingCertId = certId;
  currentImageFile = null;
  imagePreview.innerHTML = '';
  if (s.imageURL) { const img = document.createElement('img'); img.src=s.imageURL; img.className='passport'; imagePreview.appendChild(img); }
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

window.deleteStudent = async function(certId) {
  if (!confirm('Are you sure you want to delete this student?')) return;
  try { await deleteDoc(doc(db, "Students", certId)); alert('Student deleted.'); loadStudents(searchInput.value.trim()); }
  catch(err){ console.error(err); alert('Error deleting student.'); }
};

searchInput.addEventListener('input', () => { loadStudents(searchInput.value.trim()); });
resetBtn.addEventListener('click', () => { studentForm.reset(); certIdEl.disabled=false; editingCertId=null; currentImageFile=null; imagePreview.innerHTML=''; uploadProgressEl.style.display='none'; uploadProgressBar.style.width='0%'; });

function escapeHtml(str) {
  if (!str && str !== '') return '';
  return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function escapeJs(str) {
  if (!str && str !== '') return '';
  return String(str).replace(/'/g,"\\'").replace(/"/g,'\\"');
}

loadStudents();
</script>

</body>
</html>